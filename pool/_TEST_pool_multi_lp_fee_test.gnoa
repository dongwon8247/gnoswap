package pool

import (
	"encoding/gjson"
	"std"
	"testing"

	"gno.land/p/demo/testutils"

	_ "gno.land/r/grc20_wrapper"
)

var (
	gsa = testutils.TestAddress("gsa") // Gnoswap Admin

	lp01 = testutils.TestAddress("lp01") // Liquidity Provider 01
	lp02 = testutils.TestAddress("lp02") // Liquidity Provider 02

	tr01 = testutils.TestAddress("tr01") // Trader 01

	pc01 = testutils.TestAddress("pc01") // Pool Creator 01

	poolAddr = std.DerivePkgAddr("gno.land/r/pool")
	posAddr  = std.DerivePkgAddr("gno.land/r/position")
)

var (
	// Common
	barPath = "gno.land/r/bar" // token1
	fooPath = "gno.land/r/foo" // token2
	pFee    = uint16(500)

	test_tickLower       = int32(9000)
	test_tickUpper       = int32(11000)
	test_liquidityExpect = bigint(1000)
)

// 1. Init & Create Pool using Factory Contract by gsa
func TestFactoryCreatePool(t *testing.T) {
	std.TestSetOrigCaller(gsa)
	InitManual()

	std.TestSetOrigCaller(pc01)
	CreatePool(fooPath, barPath, pFee, 130622891405341611593710811006)
	// 130621891405341611593710811006 // 9999
	// 130622891405341611593710811006 // 10000

	// fee
	// 500		= 0.05% // USv3 default
	// 3000		= 0.3% // USv3 default
	// 10000	= 1% // USv3 default

	// sqrtPrice
	// 130621891405341611593710811006 // tick = 10000
	shouldPanic(t, func() { CreatePool(fooPath, barPath, 500, 130621891405341611593710811006) })
}

// Swap by tr01, Mint by lp01 ~ 02
func TestSwap(t *testing.T) {
	pool := GetPool(fooPath, barPath, pFee)

	// lp01 mint 9000 ~ 11000 tick range
	std.TestSetPrevRealm("gno.land/r/position")
	std.TestSetOrigCaller(lp01)
	Mint(fooPath, barPath, pFee, posAddr, int32(-887270), int32(887270), test_liquidityExpect*10000)

	// lp02 mint (almost) full range
	// fee 500 will use tickSpacing 10
	// MIN_TICK bigint = -887272
	// MAX_TICK bigint = 887272

	std.TestSetOrigCaller(lp02)
	Mint(fooPath, barPath, pFee, posAddr, int32(9990), int32(10010), test_liquidityExpect*10000)

	{
		// balance before swap
		poolOldToken0Bal := balanceOfByRegisterCall(pool.token0Path, poolAddr)
		poolOldToken1Bal := balanceOfByRegisterCall(pool.token1Path, poolAddr)

		userOldToken0Bal := balanceOfByRegisterCall(pool.token0Path, tr01)
		userOldToken1Bal := balanceOfByRegisterCall(pool.token1Path, tr01)

		tr01OldToken0Bal := balanceOfByRegisterCall(pool.token0Path, tr01)
		tr01OldToken1Bal := balanceOfByRegisterCall(pool.token1Path, tr01)

		lp01OldToken0Bal := balanceOfByRegisterCall(pool.token0Path, lp01)
		lp01OldToken1Bal := balanceOfByRegisterCall(pool.token1Path, lp01)

		lp02OldToken0Bal := balanceOfByRegisterCall(pool.token0Path, lp02)
		lp02OldToken1Bal := balanceOfByRegisterCall(pool.token1Path, lp02)

		// SWAP
		std.TestSetPrevRealm("gno.land/r/router")
		std.TestSetOrigCaller(tr01)
		s0, s1 := Swap(fooPath, barPath, pFee, tr01, true, bigint(100000), MIN_PRICE, std.GetOrigCaller()) // one iteration - yes fee(only lp02)
		shouldNEQ(t, s0, bigint(0))
		shouldNEQ(t, s1, bigint(0))

		// balance after swap
		poolNewToken0Bal := balanceOfByRegisterCall(pool.token0Path, GetOrigPkgAddr())
		poolNewToken1Bal := balanceOfByRegisterCall(pool.token1Path, GetOrigPkgAddr())

		tr01NewToken0Bal := balanceOfByRegisterCall(pool.token0Path, tr01)
		tr01NewToken1Bal := balanceOfByRegisterCall(pool.token1Path, tr01)

		lp01NewToken0Bal := balanceOfByRegisterCall(pool.token0Path, lp01)
		lp01NewToken1Bal := balanceOfByRegisterCall(pool.token1Path, lp01)

		lp02NewToken0Bal := balanceOfByRegisterCall(pool.token0Path, lp02)
		lp02NewToken1Bal := balanceOfByRegisterCall(pool.token1Path, lp02)

		// To collect fee wihout removing liquidity
		// burn 0
		// then collect
		std.TestSetPrevRealm("gno.land/r/position")
		std.TestSetOrigCaller(lp01)
		Burn(fooPath, barPath, pFee, int32(-887270), int32(887270), 0)
		lp01f0, lp01f1 := Collect(fooPath, barPath, pFee, lp01, int32(-887270), int32(887270), 100000000, 100000000)

		std.TestSetOrigCaller(lp02)
		Burn(fooPath, barPath, pFee, int32(9990), int32(10010), 0)
		lp02f0, lp02f1 := Collect(fooPath, barPath, pFee, lp02, int32(9990), int32(10010), 100000000, 100000000)
	}
}

/* GETTER_API TEST */
func TestApiGetPools(t *testing.T) {
	gpls := ApiGetPools()
	jsonStr := gjson.Parse(gpls)

	shouldEQ(t, jsonStr.Get("stat.height").Int(), GetHeight())
	shouldEQ(t, jsonStr.Get("stat.timestamp").Int(), GetTimestamp())

	shouldEQ(t, len(jsonStr.Get("response.data").Array()), 1)
	shouldEQ(t, jsonStr.Get("response.data").Array()[0].String(), "gno.land/r/bar:gno.land/r/foo:500")
}

func TestApiGetPool(t *testing.T) {
	gpl := ApiGetPool("gno.land/r/bar:gno.land/r/foo:500")
	jsonStr := gjson.Parse(gpl)

	shouldEQ(t, jsonStr.Get("stat.height").Int(), GetHeight())
	shouldEQ(t, jsonStr.Get("stat.timestamp").Int(), GetTimestamp())

	shouldEQ(t, len(jsonStr.Get("response.data.positions").Array()), 2)
}

/* HELPER */
func shouldEQ(t *testing.T, got, expected interface{}) {
	if got != expected {
		t.Errorf("got %v, expected %v", got, expected)
	}
}

func shouldNEQ(t *testing.T, got, expected interface{}) {
	if got == expected {
		t.Errorf("got %v, didn't expected %v", got, expected)
	}
}

func shouldPanic(t *testing.T, f func()) {
	defer func() {
		if r := recover(); r == nil {
			t.Errorf("expected panic")
		}
	}()
	f()
}
