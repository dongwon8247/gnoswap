package pool

import (
	"std"
	"testing"

	_ "gno.land/r/demo/grc20_wrapper"
)

var (
	sqrtPrice bigint = 130621891405341611593710811006

	tickLower       = int32(9000)
	tickUpper       = int32(11000)
	liquidityExpect = bigint(100_000_000_000)

	currentTick = int32(10000)
)

func TestInitManual(t *testing.T) {
	std.TestSetOrigCaller(test1)
	InitManual()

	CreatePool(fooPath, barPath, fee500, sqrtPrice)
}

func TestGetSqrtRatioFromTick(t *testing.T) {
	sqrtX96 := GetSqrtRatioFromTick(currentTick)
	shouldEQ(t, sqrtX96, sqrtPrice)
}

func TestGetTickFromSqrtRatio(t *testing.T) {
	tick := GetTickFromSqrtRatio(sqrtPrice)
	shouldEQ(t, tick, 9999) // currentTick - 1
}

func TestDrySwap_ZeroForOneTrue_AmountSpecified_Positive_16000(t *testing.T) {
	std.TestSetPrevRealm("gno.land/r/demo/position")
	std.TestSetOrigCaller(test1)

	// no mint == no liquidity => swap will fail
	_, _, ok := DrySwap(fooPath, barPath, fee500, "_", true, 16000, MIN_PRICE)
	shouldEQ(t, ok, false)

	// not enough mint == swap will fail
	Mint(fooPath, barPath, fee500, posAddr, -tickUpper, -tickLower, 1000)
	_, _, ok = DrySwap(fooPath, barPath, fee500, "_", true, 16000, MIN_PRICE)
	shouldEQ(t, ok, false)

	Mint(fooPath, barPath, fee500, posAddr, -tickUpper, -tickLower, liquidityExpect) // -11000  ~ -9000

	// zeroForOne true
	// amountSpecified 16000
	poolIn, poolOut, _ := DrySwap(
		fooPath,   // fooPath
		barPath,   // barPath
		fee500,    // fee500
		"_",       // recipient
		true,      // zeroForOne
		16000,     // amountSpecified
		MIN_PRICE, // sqrtPriceLimitX96
	)
	shouldEQ(t, poolIn, bigint(16000))
	shouldEQ(t, poolOut, bigint(-5884))
}

func TestDrySwap_ZeroForOneTrue_AmountSpecified_Negative_16000(t *testing.T) {
	// zeroForOne true
	// amountSpecified -16000

	poolIn, poolOut, _ := DrySwap(
		fooPath,   // fooPath
		barPath,   // barPath
		fee500,    // fee500
		"_",       // recipient
		true,      // zeroForOne
		-16000,    // amountSpecified
		MIN_PRICE, // sqrtPriceLimitX96
	)

	shouldEQ(t, poolIn, bigint(43506))
	shouldEQ(t, poolOut, bigint(-15999))
}

func TestDrySwap_ZeroForOneFalse_AmountSpecified_Positive_16000(t *testing.T) {
	// zeroForOne false
	// amountSpecified 16000

	poolOut, poolIn, _ := DrySwap(
		fooPath,   // fooPath
		barPath,   // barPath
		fee500,    // fee500
		"_",       // recipient
		false,     // zeroForOne
		16000,     // amountSpecified
		MAX_PRICE, // sqrtPriceLimitX96
	)

	shouldEQ(t, poolOut, bigint(-43464))
	shouldEQ(t, poolIn, bigint(16000))
}

func TestDrySwap_ZeroForOneFalse_AmountSpecified_Negative_16000(t *testing.T) {
	// zeroForOne false
	// amountSpecified -16000
	poolOut, poolIn, _ := DrySwap(
		fooPath,   // fooPath
		barPath,   // barPath
		fee500,    // fee500
		"_",       // recipient
		false,     // zeroForOne
		-16000,    // amountSpecified
		MAX_PRICE, // sqrtPriceLimitX96
	)
	shouldEQ(t, poolOut, bigint(-15999))
	shouldEQ(t, poolIn, bigint(5888))
}
